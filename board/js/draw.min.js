const MAX_MS_PER_DIFF=100;let mainCanvas,mainCtx,pushDot,timeLast,myCoordsIndex,fbCon,boardRef,usersRef,isDown=!1,myCoords=[];const boardId=extractQueryString("id");function init(){connect(boardId),mainCanvas=document.getElementById("myCanvas"),(mainCtx=mainCanvas.getContext("2d")).lineWidth=2,mainCanvas.addEventListener("mousedown",handleMouseEvent,!1),mainCanvas.addEventListener("mousemove",handleMouseEvent,!1),mainCanvas.addEventListener("mouseup",handleMouseEvent,!1),mainCanvas.addEventListener("mouseout",handleMouseEvent,!1);for(const e of document.getElementsByClassName("color-button")){const t=getComputedStyle(e).backgroundColor;e.addEventListener("click",e=>setColor(t))}for(const e of document.getElementsByClassName("size-button")){const t=getComputedStyle(e).getPropertyValue("--size");e.addEventListener("click",e=>mainCtx.lineWidth=t)}document.getElementById("clear-button").addEventListener("click",e=>destroyBoard())}function handleMouseEvent(e){if(fbCon)switch(e.type){case"mousedown":{const t=e.clientX-mainCanvas.offsetLeft,n=e.clientY-mainCanvas.offsetTop;myCoords.push({x:t,y:n}),drawDot(t,n,mainCtx),isDown=!0,pushDot=!0,timeLast=Date.now(),myCoordsIndex=0;break}case"mousemove":if(isDown){const t=e.clientX-mainCanvas.offsetLeft,n=e.clientY-mainCanvas.offsetTop;myCoords.push({x:t,y:n}),drawLine(t,n,mainCtx);const o=Date.now();if(o-timeLast>MAX_MS_PER_DIFF){const e=myCoords.length;pushDiff(myCoordsIndex,e),myCoordsIndex=e>1?e-2:0,timeLast=o}}break;case"mouseout":if(!isDown)break;case"mouseup":pushDiff(myCoordsIndex,myCoords.length,timeLast,Date.now()),myCoords=[],isDown=!1}}function setColor(e){mainCtx.strokeStyle=e,mainCtx.fillStyle=e}function drawDot(e,t,n){const o=Math.floor(n.lineWidth/2);n.moveTo(e-o,t-o),n.beginPath(),n.fillRect(e-o,t-o,n.lineWidth,n.lineWidth),n.closePath(),drawLine(e,t,n)}function drawLine(e,t,n){n.lineTo(e,t),n.stroke()}function destroyBoard(){mainCtx.clearRect(0,0,mainCanvas.width,mainCanvas.height),boardRef.child("diffs").set(null),boardRef.child("diffs").push({clear:!0})}function connect(e){firebase.auth().onAuthStateChanged(t=>{if(t){console.log("connected"),fbCon=firebase.database().ref(),null===e?(usersRef=fbCon.child("users").push({[t.uid]:!0}),e=usersRef.getKey(),history.replaceState({},"",window.location.href+"?id="+e)):usersRef=fbCon.child("users").child(e),boardRef=fbCon.child("boards").child(e),firebase.database().ref(".info/connected").on("value",e=>{!0===e.val()&&(usersRef.update({[t.uid]:!0}),usersRef.onDisconnect().update({[t.uid]:!1}))}),boardRef.child("diffs").on("child_added",mergeDiff)}else console.log("Failed to connect to Firebase.")})}function pushDiff(e,t){const n={coords:myCoords.slice(e,t),color:mainCtx.strokeStyle,lineWidth:mainCtx.lineWidth};pushDot&&(n.drawDot=!0,pushDot=!1),boardRef.child("diffs").push(n)}function mergeDiff(e){if(e.hasChild("clear"))mainCtx.clearRect(0,0,mainCanvas.width,mainCanvas.height);else{const t=e.child("coords").val(),n=e.child("color").val(),o=document.createElement("canvas");o.width=mainCanvas.width,o.height=mainCanvas.height;const a=o.getContext("2d");a.strokeStyle=n,a.fillStyle=n,a.lineWidth=e.child("lineWidth").val(),e.child("drawDot").val()?drawDot(t[0].x,t[0].y,a):a.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;++e)drawLine(t[e].x,t[e].y,a);mainCtx.drawImage(o,0,0),a.clearRect(0,0,o.width,o.height)}}function extractQueryString(e){const t=window.location.href;e=e.replace(/[[\]]/g,"\\$&");const n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}